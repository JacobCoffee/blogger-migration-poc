<!DOCTYPE html>
<html lang="en" data-accent-color="indigo" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>The Python Language Summit 2023: Towards Native Profiling for Python - Python Blog</title><link rel="shortcut icon" href="../../_static/badge.svg"/><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=301e5329" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    



</head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <strong>Python Blog</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/dev/">
                <span>Contributing</span>
                <small>Learn how to contribute to the Python project</small>
              </a></li><li><a href="https://policies.python.org/python.org/code-of-conduct/">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Python community</small>
              </a></li><li><a href="https://www.python.org/dev/security/">
                <span>Security</span>
                <small>Overview of PSFs's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/psf-landing/">
                <span>Python Software Foundation</span>
                <small>Details about the PSF</small>
              </a></li><li><a href="https://www.python.org/downloads/">
                <span>Releases</span>
                <small>Explore the latest Python releases</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/python">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://discuss.python.org/">
                <span>Board Discussions</span>
                <small>Board Discussions</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/python">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div><div class="sy-container mx-auto body">
    <main class="sy-content mx-auto pt-12 px-6 xl:px-12 break-words">
      <article class="yue" role="main">
        
<section id="the-python-language-summit-2023-towards-native-profiling-for-python">
<h1>The Python Language Summit 2023: Towards Native Profiling for Python<a class="headerlink" href="#the-python-language-summit-2023-towards-native-profiling-for-python" title="Link to this heading">¶</a></h1>
<p><em>This was originally posted on blogger</em> <a class="reference external" href="https://pyfound.blogspot.com/2023/05/the-python-language-summit-2023-towards.html">here</a>.</p>
<p>Joannah Nanjekye came to the <a class="reference external" href="https://pyfound.blogspot.com/2023/05/the-python-language-summit-2023_29.html">Python Language Summit
2023</a> to discuss innovations by
<a class="reference external" href="https://github.com/plasma-umass/scalene">Scalene</a>, a sampling-based Python
profiler that can distinguish between native code and Python code in its
reports. After its initial release in late 2019, Scalene has become one of the
most popular Python profiling tools. It has now been downloaded 500,000 times
from PyPI.</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4ACb3kr0fWAbdjl0tzHpGzioUYGYX9wrXnK915nFqYIKZPU_-DRDuiT1RVqY9FUs4-C4mwMeEnoKWP284KUtqm2Y7O4MJTSrUIHEeptUZl4U_dB4Q6Q3j_7mWveS-ksCQTD662HbZW3tInYRVrKia0qFxl6VC-TDg3pIrv3qcv6totiI/s320/image_2023-05-27_222414441.png">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/">https://blogger.googleusercontent.com/img/b/R29vZ2xl/</a><a href="#id7"><span class="problematic" id="id8">AVvXsEi4ACb3kr0fWAbdjl0tzHpGzioUYGYX9wrXnK915nFqYIKZPU_</span></a>-
DRDuiT1RVqY9FUs4-C4mwMeEnoKWP284KUtqm2Y7O4MJTSrUIHEeptUZl4U_dB4Q6Q3j_7mWveS-
ksCQTD662HbZW3tInYRVrKia0qFxl6VC-
TDg3pIrv3qcv6totiI/s1180/image_2023-05-27_222414441.png)
—
The Scalene project logo</p>
<p>A profiler is a tool that can monitor a program as it is running. Once the
program has run, the profiler can provide a report analysing which lines of
code were visited most often, which were the most expensive in terms of time
spent, and which were the most expensive in terms of memory usage. Profilers
can therefore be hugely useful tools for addressing performance issues in
code. If you’re unsure where your program is spending most of its time, it can
be hard to optimise it.</p>
<p>Profilers can be split into two broad categories: trace-based profilers and
sampling-based profilers. Trace-based profilers work by intercepting each
function call as your program is running and logging information about the
time spent, memory usage, etc. Sampling-based profilers, meanwhile, take
snapshots of your program at periodic intervals to monitor these things. A
trace-based profiler has the advantage that it can provide a granular and
precise level of detail about which lines of code were executed and when each
function call finishes; this makes it ideal for use as a tool to monitor test
coverage, for example. However, injecting tracing hooks into each function
call can sometimes slow down a program and distort the analysis of where most
time was spent. As a result, sampling-based profilers are sometimes preferred
for profiling performance.</p>
<p>Scalene is a sampling-based profiler, and aims to address the shortcomings of
previous sampling-based profilers for Python. One of the key challenges
sampling-based profilers have faced in the past has been accurately measuring
the time Python programs spend in “native code”.</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghK9GiEpyTkxBrAoaC_bG_5ophtqVcxtc-70dyCa5Y2g35CoVdQiPjiTc2lr4x4UeRq6bJW-TwhfT0kDykcpTS3GZubW9BwrnqoWxnTHe5L5Vih6H-NsAkq_OrmCiWQyWTwG7u_2rQIH6mIsIHcRAtS2KHIyIrvofK1TIpIrSR-iJrOCw/s320/Nanjekye%20slide%20screenshot.png">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghK9GiEpyTkxBrAoaC_bG_5ophtqVcxtc-70dyCa5Y2g35CoVdQiPjiTc2lr4x4UeRq6bJW">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghK9GiEpyTkxBrAoaC_bG_5ophtqVcxtc-70dyCa5Y2g35CoVdQiPjiTc2lr4x4UeRq6bJW</a>-
TwhfT0kDykcpTS3GZubW9BwrnqoWxnTHe5L5Vih6H-NsAkq_OrmCiWQyWTwG7u_2rQIH6mIsIHcRAtS2KHIyIrvofK1TIpIrSR-
iJrOCw/s1192/Nanjekye%20slide%20screenshot.png)
—
Slide from Nanjekye’s talk, illustrating sampling-based profiling</p>
<section id="handling-the-problem-of-native-code">
<h2>Handling the problem of native code<a class="headerlink" href="#handling-the-problem-of-native-code" title="Link to this heading">¶</a></h2>
<p>“Native code”, also sometimes referred to as “machine code”, refers to code
consisting of low-level instructions that can be interpreted directly by the
hardware processor. Using extensions to Python written in
<a href="#id9"><span class="problematic" id="id10">`C &lt;https://en.wikipedia.org/wiki/C_\(programming_language\&gt;`_</span></a>),
<a class="reference external" href="https://en.wikipedia.org/wiki/C%2B%2B">C++</a> or <a class="reference external" href="https://www.rust-lang.org">Rust</a> that will compile to native code – such as
<a class="reference external" href="https://numpy.org">NumPy</a>, <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>,
and <a class="reference external" href="https://www.tensorflow.org">TensorFlow</a> – can lead to dramatic speedups
for a program written in Python.</p>
<p>It also, however, makes life difficult for sampling-based profilers. Samplers
often use Python’s <a href="#id3"><span class="problematic" id="id4">``</span></a>signal` &lt;<a class="reference external" href="https://docs.python.org/3/library/signal.html">https://docs.python.org/3/library/signal.html</a>&gt;`_
module as a way of knowing when to take a periodic snapshot of a program as it
is running. However, due to the way the <cite>signal</cite> module works, no signalling
events will be delivered while a Python program is spending time in a function
that has been compiled to native code via an extension module. The upshot of
this is that sample-based profilers are often “flying blind” for Python code
that makes extensive use of C extensions, and will sometimes erroneously
report that no time at all was spent executing native code, even if the
program in fact spent the majority of its time there.</p>
<p>Scalene’s solution to this problem is to monitor delays in signal delivery. It
uses this information to deduce the amount of time that the program spent
outside CPython’s main interpreter loop (due to the use of native, compiled
code from an extension module). Further details on Scalene’s methods, and
comparisons with other leading Python profilers, can be found in a recent
paper by Emery D. Berger, Sam Stern and Juan Altmayer Pizzorno,
<a class="reference external" href="https://arxiv.org/pdf/2212.07597.pdf">“Triangulating Python Performance Issues with
Scalene”</a>.</p>
<p>Nanjekye also detailed Scalene’s sophisticated approach to measuring
performance in child threads. Signal-based profilers often struggle with
multi-threaded code, as signals can only be delivered and received from the
main thread in Python. Scalene’s solution is to monkey-patch functions that
might block the main thread, and add timeouts to these functions. This allows
signals to be delivered even in multithreaded code.</p>
</section>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Link to this heading">¶</a></h2>
<p>Nanjekye asked attendees at the Language Summit if they would be interested in
integrating Scalene’s ideas into the standard library’s
<a href="#id5"><span class="problematic" id="id6">``</span></a>cProfile &lt;<a class="reference external" href="https://docs.python.org/3/library/profile.html">https://docs.python.org/3/library/profile.html</a>&gt;`_` module, which was
met with a somewhat muted response.</p>
<p>Pablo Galindo Salgado, a leading contributor to the
<a class="reference external" href="https://github.com/bloomberg/memray">Memray</a> profiler, criticised Scalene’s
signal-based approach, arguing it relied on inherently brittle monkey-patching
of the standard library. It also reported unreliable timings, Salgado said:
for example, if code in a C extension checks for signals to support CTRL-C,
the resulting delays measured by Scalene will be distorted.</p>
<p>Salgado argued that integration with <cite>the `perf</cite>
profiler &lt;<a class="reference external" href="https://docs.python.org/3.12/howto/perf_profiling.html#perf">https://docs.python.org/3.12/howto/perf_profiling.html#perf</a>-
profiling&gt;`_, which Python is introducing support for in Python 3.12, would be a
better option for users. Mark Shannon, however, argued that <cite>perf</cite> distorted
the execution time of Python programs; Salgado responded that Scalene did as
well, as the use of signals came with its own overhead.</p>
<p>Nanjekye argued that the huge popularity of Scalene in the Python ecosystem
was evidence that it had proved its worth. Carol Willing concurred, noting
that Scalene was an especially useful tool with code that made heavy use of
libraries such as NumPy, Scikit-Learn and PyTorch.</p>
</section>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    Previous:
    
    <a href="2023-05-the-python-language-summit-2023-three.html">
      
      <span>The Python Language Summit 2023: Three Talks on the C API</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    Next:
    
    <a href="2023-05-the-python-language-summit-2023-what-is.html">
      <span>The Python Language Summit 2023: What is the Standard Library for?</span>
      
    </a>
    
  </span>
</div>

  
  
</div>

      </article>
      
    </main>
  </div><footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Python Software Foundation</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=8a448e45"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../_static/shibuya.js?v=3cc430e2"></script></body>
</html>