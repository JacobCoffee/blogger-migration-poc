<!DOCTYPE html>
<html lang="en" data-accent-color="indigo" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>HPy: a future-proof way of extending Python? - Python Language Summit 2020 - Python Blog</title><link rel="shortcut icon" href="../../_static/badge.svg"/><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=301e5329" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    



</head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <strong>Python Blog</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/dev/">
                <span>Contributing</span>
                <small>Learn how to contribute to the Python project</small>
              </a></li><li><a href="https://policies.python.org/python.org/code-of-conduct/">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Python community</small>
              </a></li><li><a href="https://www.python.org/dev/security/">
                <span>Security</span>
                <small>Overview of PSFs's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/psf-landing/">
                <span>Python Software Foundation</span>
                <small>Details about the PSF</small>
              </a></li><li><a href="https://www.python.org/downloads/">
                <span>Releases</span>
                <small>Explore the latest Python releases</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/python">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://discuss.python.org/">
                <span>Board Discussions</span>
                <small>Board Discussions</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/python">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div><div class="sy-container mx-auto body">
    <main class="sy-content mx-auto pt-12 px-6 xl:px-12 break-words">
      <article class="yue" role="main">
        
<section id="hpy-a-future-proof-way-of-extending-python-python-language-summit-2020">
<h1>HPy: a future-proof way of extending Python? - Python Language Summit 2020<a class="headerlink" href="#hpy-a-future-proof-way-of-extending-python-python-language-summit-2020" title="Link to this heading">¶</a></h1>
<p><em>This was originally posted on blogger</em> <a class="reference external" href="https://pyfound.blogspot.com/2020/04/hpy-future-proof-way-of-extending.html">here</a>.</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi83fOiYUKkQgeZk6-ESclX7wvTvu1GsbgkUVo2xkety6Ohv2Q6vf8KzlRL0jis93K4FFlwPmtpko-T7_YX_GWImY9ChJNOsXP4Wo7qvJip6uqrUTAnMXAIknEgZey58GPj3g/s1600/antonio-cuni.jpeg">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi83fOiYUKkQgeZk6-ESclX7wvTvu1GsbgkUVo2xkety6Ohv2Q6vf8KzlRL0jis93K4FFlwPmtpko-T7_YX_GWImY9ChJNOsXP4Wo7qvJip6uqrUTAnMXAIknEgZey58GPj3g/s1600/antonio">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi83fOiYUKkQgeZk6-ESclX7wvTvu1GsbgkUVo2xkety6Ohv2Q6vf8KzlRL0jis93K4FFlwPmtpko-T7_YX_GWImY9ChJNOsXP4Wo7qvJip6uqrUTAnMXAIknEgZey58GPj3g/s1600/antonio</a>-
cuni.jpeg)
Antonio Cuni presented <a class="reference external" href="https://github.com/pyhandle/hpy">HPy</a> (pronounced
“aitch pi”), an attempt at a replacement C API that is compatible and
performant across several interpreter implementations. The idea was born at
EuroPython last year from a discussion among CPython, PyPy, and Cython
developers.</p>
<p><a class="reference external" href="https://pyfound.blogspot.com/2020/04/the-2020-python-language-summit.html">Read more 2020 Python Language Summit
coverage.</a></p>
<ul class="simple">
<li><ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>CPython’s API for C extensions is tightly coupled with the interpreter’s
internals. Another interpreter such as Jython, if it wants to support the same
C extensions, must emulate these internals, pretending to the C extension that
the interpreter works the same as CPython. Even CPython suffers: any of its
internals that are exposed in the C API can’t be improved without breaking
compatibility. Python objects in the C API are pointers to CPython’s PyObject
structs, whose internal layout is partly exposed to extensions. Extensions
expect each PyObject pointer to be constant for the object’s lifetime, which
prevents a memory manager like PyPy’s from <a class="reference external" href="https://doc.pypy.org/en/latest/gc_info.html">moving objects during garbage
collection</a>.</p>
<p>Most prominently, the C API requires extensions to control objects’ lifetimes
by incrementing and decrementing their reference counts. Any Python
implementation that does _not_ have a reference-counting memory manager, such
as PyPy, <a class="reference external" href="https://morepypy.blogspot.com/2018/09/inside-cpyext-why-emulating-cpython-c.html">must emulate refcounts for the sake of the C
API</a>. Cuni calls this a “massive amount of precious developer hours
wasted,” an impediment to performance, and the main obstacle for Larry
Hastings’s <a class="reference external" href="https://lwn.net/Articles/754577/">GILectomy</a>.</p>
<p>Victor Stinner has already <a class="reference external" href="https://pythoncapi.readthedocs.io/">outlined the design for a better C
API</a> that hides some internals, but still
depends on reference-counting; Cuni confronts the same questions and gives a
more radical answer.</p>
<p>HPy is a new C API that is interpreter-agnostic. Instead of PyObject pointers,
HPy presents _handles_ (hence the “H” in its name). Where a C API user would
incref a PyObject when copying a reference to it, an HPy user would
_duplicate_ a handle. Each handle is distinct and must be closed
independently. Cuni showed this code example:</p>
<blockquote>
<div><p>/* C API <em>/
PyObject *a = PyLong_FromLong(42);
PyObject *b = a;
Py_INCREF(b);
Py_DECREF(a);
Py_DECREF(a); // Ok
/</em> HPy <a href="#id2"><span class="problematic" id="id3">*</span></a>/
HPy a = HPyLong_FromLong(ctx, 42);
HPy b = HPy_Dup(ctx, a);
HPy_Close(a);
HPy_Close(a); // WRONG!</p>
</div></blockquote>
<p>Handles are HPy’s basic departure from the C API. The independence of handles’
liftimes, said Cuni, decouples HPy from CPython’s ref-counting memory manager,
and makes HPy a natural, fast C interface for other Pythons. PyPy, for
example, will maintain a map of handles to objects; when its garbage collector
moves objects in memory, it only needs to update the map. Handles permit
precise debugging: if a handle is leaked, HPy prints the line number where it
was created. (The HPy context parameter <cite>ctx</cite> that is passed everywhere allows
for subinterpreters, and perhaps other features in the future.)</p>
<p>Brett Cannon asked whether HPy will be a minimalist API for extension
development, or if it will include specialized APIs for speed. For example,
the current C API has a generic <cite>PyObject_GetItem</cite>, and a fast
<cite>PyDict_GetItem</cite> specialized for dicts. Cuni said he prefers a smaller API,
but benchmarks would guide him.</p>
<p>Cannon asked whether a tool could semi-automatically port C code from the C
API to HPy. It could not, according to Cuni, because the problem of closing
each handle exactly once must be solved carefully by a human. HPy’s debug
messages will be a great help. “In theory,” Cuni said, “it should be as easy
as adding an ‘H’ to all C API calls, renaming <cite>Py_INCREF</cite> to <cite>HPy_Dup</cite>,
putting <cite>HPy_Close</cite> here and there, and then see if the debug mode is happy or
complains.”</p>
<p>Victor Stinner asked whether his <a class="reference external" href="https://github.com/vstinner/misc/blob/master/cpython/pep-opaque-c-api.rst">draft proposal to incrementally modify the C
API to hide
internals</a> would eventually solve PyPy’s problems with C extensions. Cuni
replied, “It’s not enough for PyPy because of reference counting and the fact
that <cite>PyObject*</cite> is not a good representation for objects that can move in
memory.” But he acknowledged that Stinner’s proposal goes in the right
direction.</p>
<p>Cuni said the “HPy strategy to conquer the world” is to create a zero-overhead
façade that maps HPy to the C API (using compile-time macros), then port
third-party C extensions to pure HPy, one function at a time. It must be
faster on alternative implementations than their existing C API emulations;
<a class="reference external" href="https://morepypy.blogspot.com/2019/12/hpy-kick-off-sprint-report.html">early benchmarks show a 3x speedup on
PyPy</a>
and 2x on <a class="reference external" href="https://github.com/graalvm/graalpython">GraalPython</a>, a JVM-based
Python.</p>
<p><a class="reference external" href="https://hpy.readthedocs.io/en/latest/overview.html#current-status-and-roadmap">HPy is currently missing type
objects</a>, but Cuni said it “basically works.” An HPy extension can be
compiled to the CPython ABI or to an “HPy universal ABI” that allows the same
compiled extension to work with multiple interpreters. In the future, a new
Cython backend will target HPy instead of the C API. Cuni and his
collaborators have ported <a class="reference external" href="https://pypi.org/project/ujson/">ujson</a> to HPy;
they plan to port <a class="reference external" href="https://github.com/paugier/piconumpy">a subset of NumPy</a>
next, and eventually to write a PEP and merge HPy into the official CPython
distribution, where it will live alongside the existing C API. Cuni hopes the
core developers will endorse HPy for third-party C extension development; in a
“hypothetical sci-fi future” CPython might port its standard library C modules
to HPy.</p>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    Previous:
    
    <a href="2020-04-cpython-documentation-next-5-years.html">
      
      <span>CPython Documentation: The Next 5 Years - Python Language Summit 2020</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    Next:
    
    <a href="2020-04-lightning-talks-part-1.html">
      <span>Lightning Talks Part 1 - Python Language Summit 2020</span>
      
    </a>
    
  </span>
</div>

  
  
</div>

      </article>
      
    </main>
  </div><footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Python Software Foundation</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=8a448e45"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../_static/shibuya.js?v=3cc430e2"></script></body>
</html>