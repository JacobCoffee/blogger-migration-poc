<!DOCTYPE html>
<html lang="en" data-accent-color="indigo" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>A formal specification for the (C)Python virtual machine - Python Language Summit 2020 - Python Blog</title><link rel="shortcut icon" href="../../_static/badge.svg"/><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=301e5329" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    



</head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <strong>Python Blog</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/dev/">
                <span>Contributing</span>
                <small>Learn how to contribute to the Python project</small>
              </a></li><li><a href="https://policies.python.org/python.org/code-of-conduct/">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Python community</small>
              </a></li><li><a href="https://www.python.org/dev/security/">
                <span>Security</span>
                <small>Overview of PSFs's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/psf-landing/">
                <span>Python Software Foundation</span>
                <small>Details about the PSF</small>
              </a></li><li><a href="https://www.python.org/downloads/">
                <span>Releases</span>
                <small>Explore the latest Python releases</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/python">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://discuss.python.org/">
                <span>Board Discussions</span>
                <small>Board Discussions</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/python">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div><div class="sy-container mx-auto body">
    <main class="sy-content mx-auto pt-12 px-6 xl:px-12 break-words">
      <article class="yue" role="main">
        
<section id="a-formal-specification-for-the-c-python-virtual-machine-python-language-summit-2020">
<h1>A formal specification for the (C)Python virtual machine - Python Language Summit 2020<a class="headerlink" href="#a-formal-specification-for-the-c-python-virtual-machine-python-language-summit-2020" title="Link to this heading">¶</a></h1>
<p><em>This was originally posted on blogger</em> <a class="reference external" href="https://pyfound.blogspot.com/2020/04/a-formal-specification-for-cpython.html">here</a>.</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSPQl1R9HZl2vs1mjLaITIeU56Oa6KEC-hOTtVzWl80o73TXWSea0w5dhdWo21ReAPMvmtnHqLZzJ89XTmkjQp2_Fw2Xfc_8x8jY6x3n1i_YZx_TZ3nG7qzd0ulpxNjjYvug/s1600/mark-shannon.jpg">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSPQl1R9HZl2vs1mjLaITIeU56Oa6KEC">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiSPQl1R9HZl2vs1mjLaITIeU56Oa6KEC</a>-
hOTtVzWl80o73TXWSea0w5dhdWo21ReAPMvmtnHqLZzJ89XTmkjQp2_Fw2Xfc_8x8jY6x3n1i_YZx_TZ3nG7qzd0ulpxNjjYvug/s1600/mark-
shannon.jpg)
Mark Shannon began his presentation saying, “This should actually be titled A
_Semi_ -Formal Specification. I don’t think we’ll ever get to <a class="reference external" href="http://www.scholarpedia.org/article/Standard_ML_language#Language_definition">the stage of
ML</a>,”
a language described with mathematical rigor. However, a _more_ formal
definition of Python would be useful. Authors of alternative Python
implementations would have a standard to go by, besides reading CPython’s
source and testing for equivalent behavior on a variety of programs. “It seems
to work for Java so I don’t see why it wouldn’t work for Python,” said
Shannon. It would be particularly helpful for anyone who wants to examine a
part of the language. Today, one cannot understand CPython’s bytecode
interpreter without studying all its quirky interactions with the C API, the
code loader, and so on; a Python specification would break down the language
into domains that could be grasped separately.</p>
<p>A specification would clean up edge cases. Shannon said there are “too many
weird bugs relating to interactions of threads and generators and locals and
various other bits and pieces.” If the language were defined, developers would
at least know how it’s supposed to behave.</p>
<p><a class="reference external" href="https://pyfound.blogspot.com/2020/04/the-2020-python-language-summit.html">Read more 2020 Python Language Summit
coverage</a>.</p>
<ul class="simple">
<li><ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Shannon proposed to split Python’s specifications into major components: code
loading (including imports and parsing), execution, and the C API. The
components’ specs would be allowed to refer to each other, but only at a high
level. In his Language Summit presentation, Shannon focused on the execution
component.</p>
<p>A Python execution spec would define the virtual machine (VM) as a set of
variables, such as the list of threads and their call stacks, and it would
define small steps that transition from one VM state to the next. For example,
a Python function call involves these steps:</p>
<blockquote>
<div><ul class="simple">
<li><p>Create a new stack frame</p></li>
<li><p>Move arguments from current frame to the new one</p></li>
<li><p>Save the next instruction pointer</p></li>
<li><p>Push the new frame onto the call stack</p></li>
<li><p>Continue</p></li>
</ul>
</div></blockquote>
<p>Every definition ends with “continue”, meaning that the interpreter proceeds
to the next step.
Writing a specification for Python is a chance to rethink how its parts
relate. CPython’s generators are implemented in terms of iterators, because
iterators were built first. But generators are a more basic and flexible
concept; starting from scratch it’s natural to _define_ iterators in terms of
generators. Shannon presented <a class="reference external" href="https://github.com/markshannon/python_formal_semantics/blob/master/examples/iteration_and_generators.md">a sketch of such a
definition</a>.</p>
<p>The next steps for Shannon’s project are to define the spec’s format, list its
components, and decide what to do about “awkward” language features such as
<cite>sys.settrace()</cite>. He concluded that a semi-formal spec of Python would help
alternative implementations match CPython, would make PEPs less ambiguous, and
would clarify whether any existing “odd behavior is a feature or a bug.” It
would be possible to reason about the correctness of optimizations. However,
writing the spec is work, and it could deter good PEPs in the future if
authors are daunted by writing their proposals in terms of the spec.</p>
<p>The audience’s questions revealed their confusion about Shannon’s idea. Larry
Hastings admitted he had “lots of trouble following this.” Was Shannon
proposing a new language implementation based on the spec? Shannon said no,
the spec’s purpose was to describe and reason about CPython and other
implementations. A. Jesse Jiryu Davis wondered if the spec would be written in
a formal modeling language like
<a class="reference external" href="https://lamport.azurewebsites.net/tla/tla.html">TLA+</a> or
<a class="reference external" href="https://alloytools.org/about.html">Alloy</a>, but Shannon felt that would
discourage contributors. English would be the language of the spec; the <a class="reference external" href="https://docs.oracle.com/javase/specs/jvms/se7/html/">JVM
spec</a> demonstrates this
approach.</p>
<p>Brett Cannon asked if PEPs for new language features would require spec
patches. Shannon replied that PEPs for deep changes, similar to <a class="reference external" href="https://www.python.org/dev/peps/pep-0380/">the
introduction of yield from</a> in
Python 3.3, would benefit if they were described in terms of the spec.</p>
<p>The presentation ended with the attendees saying a Python specification might
be a good idea, but struggling to envision it and how it would be used in
practice.</p>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    Previous:
    
    <a href="2020-04-building-python-community-in-colombia.html">
      
      <span>Building a Python community in Colombia: John Roa, 2018 Q4 CSA Recipient</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    Next:
    
    <a href="2020-04-cpython-documentation-next-5-years.html">
      <span>CPython Documentation: The Next 5 Years - Python Language Summit 2020</span>
      
    </a>
    
  </span>
</div>

  
  
</div>

      </article>
      
    </main>
  </div><footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Python Software Foundation</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=8a448e45"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../_static/shibuya.js?v=3cc430e2"></script></body>
</html>