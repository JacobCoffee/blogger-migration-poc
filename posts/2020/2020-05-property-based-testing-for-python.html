<!DOCTYPE html>
<html lang="en" data-accent-color="indigo" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Property-Based Testing for Python builtins and the standard library - Python Language Summit 2020 - Python Blog</title><link rel="shortcut icon" href="../../_static/badge.svg"/><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=301e5329" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    



</head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <strong>Python Blog</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/dev/">
                <span>Contributing</span>
                <small>Learn how to contribute to the Python project</small>
              </a></li><li><a href="https://policies.python.org/python.org/code-of-conduct/">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Python community</small>
              </a></li><li><a href="https://www.python.org/dev/security/">
                <span>Security</span>
                <small>Overview of PSFs's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/psf-landing/">
                <span>Python Software Foundation</span>
                <small>Details about the PSF</small>
              </a></li><li><a href="https://www.python.org/downloads/">
                <span>Releases</span>
                <small>Explore the latest Python releases</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/python">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://discuss.python.org/">
                <span>Board Discussions</span>
                <small>Board Discussions</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/python">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div><div class="sy-container mx-auto body">
    <main class="sy-content mx-auto pt-12 px-6 xl:px-12 break-words">
      <article class="yue" role="main">
        
<section id="property-based-testing-for-python-builtins-and-the-standard-library-python-language-summit-2020">
<h1>Property-Based Testing for Python builtins and the standard library - Python Language Summit 2020<a class="headerlink" href="#property-based-testing-for-python-builtins-and-the-standard-library-python-language-summit-2020" title="Link to this heading">¶</a></h1>
<p><em>This was originally posted on blogger</em> <a class="reference external" href="https://pyfound.blogspot.com/2020/05/property-based-testing-for-python.html">here</a>.</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjz1wZMuiffXv0PrZJk0HaDgWpwrclKHpV-9viDxYq6bqi_PZxPNgsX_Rdpx4R9q_A5HhuIKe83qGpJNd-i4cZTSPs87E2dGGSDZbIrmRQ4K1SJq3EMQVYUEDM2mzO7yOyT9A/s320/zac-profile.jpg">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjz1wZMuiffXv0PrZJk0HaDgWpwrclKHpV-9viDxYq6bqi_PZxPNgsX_Rdpx4R9q_A5HhuIKe83qGpJNd-i4cZTSPs87E2dGGSDZbIrmRQ4K1SJq3EMQVYUEDM2mzO7yOyT9A/s1600/zac">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjz1wZMuiffXv0PrZJk0HaDgWpwrclKHpV-9viDxYq6bqi_PZxPNgsX_Rdpx4R9q_A5HhuIKe83qGpJNd-i4cZTSPs87E2dGGSDZbIrmRQ4K1SJq3EMQVYUEDM2mzO7yOyT9A/s1600/zac</a>-
profile.jpg)</p>
<p>Zac Hatfield-Dodds opened his presentation with a paraphrase of the economist
Thomas Schelling:</p>
<p>&gt; _No matter how rigorous her analysis or heroic his imagination, no person
&gt; can write a test case that would never occur to them._</p>
<p>Hatfield-Dodds told the Language Summit, handwritten tests are “fantastic for
testing particular edge cases, they’re great regression tests,” but they’re
limited by the developer’s understanding of the system under test. “We can’t
write tests for bugs we don’t know could occur.” We can overcome this limit
with _exhaustive <a href="#id2"><span class="problematic" id="id3">testing_</span></a> , checking our code’s behavior with every possible
input; if that is impractical, _coverage-guided fuzz <a href="#id4"><span class="problematic" id="id5">testing_</span></a> can generate
random inputs and evolve them, trying to explore every branch in the code
under test. Fuzzers are very good at finding inputs that crash a program, but
they’re not as well suited for finding other kinds of bugs.</p>
<p><a class="reference external" href="https://pyfound.blogspot.com/2020/04/the-2020-python-language-summit.html">Read more 2020 Python Language Summit
coverage</a>.</p>
<ul class="simple">
<li><ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>For testing the Python standard library, Hatfield-Dodds proposed a different
technique: _property-based <a href="#id6"><span class="problematic" id="id7">testing_</span></a>. (He is one of the leaders of the
<a class="reference external" href="https://hypothesis.readthedocs.io/">Hypothesis property-based testing
project</a>.) A property-based test framework
doesn’t generate totally random input like a fuzzer; it can generate
structured inputs such as lists of numbers, or only sorted lists, or instances
of a certain object. Unlike handwritten tests, which usually assert that a
particular input produces one exact output, property-based tests assert
_properties_ of a function, for example that its output is sorted, or that a
function is idempotent or commutative.</p>
<p>Hatfield-Dodds presented the following Hypothesis test of a JSON codec:</p>
<blockquote>
<div><dl>
<dt>&#64;given(</dt><dd><dl class="simple">
<dt>value=st.recursive(</dt><dd><p>st.none() | st.booleans() | st.floats() | st.text(),
lambda x: st.lists(x) | st.dictionaries(st.text(), x),</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
<p>)
def test_record_json_roundtrip(value):</p>
<blockquote>
<div><p>assume(value == value)
assert value == json.loads(json.dumps(value))</p>
</div></blockquote>
</div></blockquote>
<p>The <cite>recursive</cite> input generator can create None, booleans, floats, text, or
lists or dictionaries that contain such values, and so on recursively. Within
the test function, the <cite>assume</cite> statement checks that the input is equal to
itself, to avoid inputs with <cite>nan</cite>, which is not. The heart of the test is the
<cite>assert</cite> statement.</p>
<p>(The above example still has troubles with <cite>nan</cite>, <a class="reference external" href="https://zhd.dev/sufficiently/">see Hatfield-Dodds’ PyCon
Australia talk</a>.)</p>
<p>Hypothesis searches for bugs by randomizing the input, or trying interesting
values that tend to trigger edge cases, or retrying inputs that triggered bugs
in previous runs. When Hypothesis finds a bug, it evolves the input, searching
for the simplest input that reproduces the same bug.
![](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWbRREUd0vEfKsosDGMv9UTTkS9Vouaj-6PIEPK1mMxuwtyUBCqtbVrUO0l-C5rhCbr8ZceVKPmugJGf1Z1rayoBnkz1jNg81u2EgyEm4wMaQhnVxeVvJ6gk70t3Za4zvZsA/s1600/hypothesis">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWbRREUd0vEfKsosDGMv9UTTkS9Vouaj-6PIEPK1mMxuwtyUBCqtbVrUO0l-C5rhCbr8ZceVKPmugJGf1Z1rayoBnkz1jNg81u2EgyEm4wMaQhnVxeVvJ6gk70t3Za4zvZsA/s1600/hypothesis</a>-
minimization.png)
“I want you all to write property-based tests for CPython, for builtins, for
PyPy, for everything,” said Hatfield-Dodds. He proposed to write new tests, or
port existing ones to a property-based test framework, run them in CPython’s
continuous integration suite, and share them among the Python implementations.
These tests could use Hypothesis; they could also be integrated with the <a class="reference external" href="https://github.com/google/AFL">AFL
fuzzer</a> or used in <a class="reference external" href="https://github.com/google/oss-fuzz">Google’s OSS-
Fuzz</a> project. He presented a <a class="reference external" href="https://github.com/Zac-HD/stdlib-property-tests">repository
of tests</a> demonstrating the
technique for standard library modules such as <cite>gzip</cite>, <cite>re</cite>, and <cite>datetime</cite>.
There is even <a class="reference external" href="https://github.com/Zac-HD/stdlib-property-tests/blob/master/tests/test_source_code.py">a test that can generate random, valid Python
code</a> to fuzz-test the Python parser.</p>
<p>Łukasz Langa mentioned that <a class="reference external" href="https://www.drmaciver.com/2015/03/27-bugs-in-24-hours/">David MacIver had used Hypothesis to test a
Python code formatter</a>
and found dozens of bugs.</p>
<p>Paul Ganssle told the Summit that he used property-based testing for his
implementation of
<a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.date.fromisoformat">datetime.fromisoformat</a>.
When the function was merged into the standard library the property-based
tests were not. In subsequent development Ganssle introduced a segfault bug
that “almost certainly would have been caught” if the original tests had still
been running. He strongly endorsed Hatfield-Dodds’s idea. He added that
property-based testing is especially good at checking that two implementations
of a module, one written in Python and one in C, are equivalent.</p>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    Previous:
    
    <a href="2020-04-all-strings-become-f-strings-python.html">
      
      <span>Should All Strings Become f-strings? - Python Language Summit 2020</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    Next:
    
    <a href="2020-05-pythons-migration-to-github-request-for.html">
      <span>Python’s migration to GitHub - Request for Project Manager Resumes</span>
      
    </a>
    
  </span>
</div>

  
  
</div>

      </article>
      
    </main>
  </div><footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Python Software Foundation</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=8a448e45"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../_static/shibuya.js?v=3cc430e2"></script></body>
</html>