<!DOCTYPE html>
<html lang="en" data-accent-color="indigo" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Replacing CPython’s parser - Python Language Summit 2020 - Python Blog</title><link rel="shortcut icon" href="../../_static/badge.svg"/><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(localStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=397bb51e" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=301e5329" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    



</head>
<body><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand" href="/">
      <img class="light-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <img class="dark-logo" src="../../_static/badge.svg" alt="Python Blog" height="28" loading="lazy" />
      <strong>Python Blog</strong>
    </a>
    <div class="sy-head-nav" id="HeadNav">
      <nav class="sy-head-links"><ul><li class="link"><a href="../../index.html">Home</a></li>
      <li class="link"><button type="button">
            <span>Community</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/dev/">
                <span>Contributing</span>
                <small>Learn how to contribute to the Python project</small>
              </a></li><li><a href="https://policies.python.org/python.org/code-of-conduct/">
                <span>Code of Conduct</span>
                <small>Review the etiquette for interacting with the Python community</small>
              </a></li><li><a href="https://www.python.org/dev/security/">
                <span>Security</span>
                <small>Overview of PSFs's security protocols</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>About</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://www.python.org/psf-landing/">
                <span>Python Software Foundation</span>
                <small>Details about the PSF</small>
              </a></li><li><a href="https://www.python.org/downloads/">
                <span>Releases</span>
                <small>Explore the latest Python releases</small>
              </a></li></ul>
      </li>
      <li class="link"><button type="button">
            <span>Help</span>
            <i class="i-lucide chevron-down"></i>
          </button>
        <ul><li><a href="https://discord.gg/python">
                <span>Discord Help Forum</span>
                <small>Dedicated Discord help forum</small>
              </a></li><li><a href="https://discuss.python.org/">
                <span>Board Discussions</span>
                <small>Board Discussions</small>
              </a></li></ul>
      </li><li class="link">
          <a href="https://github.com/sponsors/python">
            <span>Sponsor</span></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form><div class="sy-head-socials"></div></div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden"><button class="js-theme theme-switch flex items-center"
data-aria-auto="Switch to light color mode"
data-aria-light="Switch to dark color mode"
data-aria-dark="Switch to auto color mode">
<i class="i-lucide theme-icon"></i>
</button><button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="HeadNav" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div><div class="sy-container mx-auto body">
    <main class="sy-content mx-auto pt-12 px-6 xl:px-12 break-words">
      <article class="yue" role="main">
        
<section id="replacing-cpythons-parser-python-language-summit-2020">
<h1>Replacing CPython’s parser - Python Language Summit 2020<a class="headerlink" href="#replacing-cpythons-parser-python-language-summit-2020" title="Link to this heading">¶</a></h1>
<p><em>This was originally posted on blogger</em> <a class="reference external" href="https://pyfound.blogspot.com/2020/04/replacing-cpythons-parser-python.html">here</a>.</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEij2mSlVzO1hlH-_7cmPi9Cj32A069h6oOFIodgjspTHHUE3BNg84Wz_hR1qBEZVg_pzMq7cepQofMNG2qBYxehsCOWFMoc1NJUT-0CTgfzYL8jcP0_uc6DqX-CN47KWT7yMg/s1600/python-language-summit-02.jpg">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEij2mSlVzO1hlH-_7cmPi9Cj32A069h6oOFIodgjspTHHUE3BNg84Wz_hR1qBEZVg_pzMq7cepQofMNG2qBYxehsCOWFMoc1NJUT-0CTgfzYL8jcP0_uc6DqX">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEij2mSlVzO1hlH-_7cmPi9Cj32A069h6oOFIodgjspTHHUE3BNg84Wz_hR1qBEZVg_pzMq7cepQofMNG2qBYxehsCOWFMoc1NJUT-0CTgfzYL8jcP0_uc6DqX</a>-
CN47KWT7yMg/s1600/python-language-summit-02.jpg)
Since its start, Python’s grammar has been
<a class="reference external" href="https://en.wikipedia.org/wiki/LL_parser">LL(1)</a>: it needs only a left-to-
right parser that looks one token ahead to resolve ambiguities. The standard
CPython parser is <a class="reference external" href="https://devguide.python.org/compiler/">produced by a simple custom parser
generator</a>. There are some costs to
this simplicity, however. First, the <a class="reference external" href="https://docs.python.org/3/reference/grammar.html">official Python grammar
file</a> does not capture the
language exactly. There are invalid constructs allowed by the grammar, for
example, this assignment expression (using the new walrus operator):</p>
<blockquote>
<div><p>[x for x in y] := [1, 2, 3]</p>
</div></blockquote>
<p>This expression is illegal, because the left side of the walrus operator must
be a name, not an arbitrary sub-expression like <cite>[x for x in y]</cite>. Python’s
LL(1) parser is not powerful enough to enforce this rule, though, so it must
be enforced after parsing by special-case logic that runs while transforming
the parse tree into the abstract syntax tree (AST).</p>
<p>Worse, there is Python code that we would like to write but cannot, because it
can’t be parsed. Parenthesized with-statements look reasonable <a class="reference external" href="https://bugs.python.org/issue12782">but they’re
currently prohibited</a>:</p>
<blockquote>
<div><dl class="simple">
<dt>with (</dt><dd><p>open(“a_really_long_foo”) as foo,
open(“a_really_long_baz”) as baz,
open(“a_really_long_bar”) as bar</p>
</dd>
<dt>):</dt><dd><p>…</p>
</dd>
</dl>
</div></blockquote>
<p><a class="reference external" href="https://pyfound.blogspot.com/2020/04/the-2020-python-language-summit.html">Read more 2020 Python Language Summit
coverage</a>.</p>
<ul class="simple">
<li><ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Guido van Rossum, Pablo Galindo, and Lysandros Nikolaou wrote a new Python
parser to excise these warts, and <a class="reference external" href="https://www.python.org/dev/peps/pep-0617/">proposed PEP
617</a> to adopt it in CPython. The
new parser is written in a more powerful style called a <a class="reference external" href="https://en.wikipedia.org/wiki/Parsing_expression_grammar">parsing expression
grammar</a> (PEG), so
the project is named “PEGEN”.</p>
<p>When a PEG parser reads the beginning of a token sequence that could match
several grammar rules, the parser tries each of those rules, from left to
right, until one succeeds. For example, given a set of rules:</p>
<blockquote>
<div><p>rule: A | B | C</p>
</div></blockquote>
<p>The parser first tries to apply rule A to its input sequence. If A succeeds,
the parser ignores B and C. Otherwise, the parser moves on and tries to apply
rule B, and so on. Unlike an LL(1) parser, a PEG parser can look ahead as far
as necessary to disambiguate a sequence. The grammar is deterministic: in
cases where multiple rules match, the leftmost wins. Some sequences would
require exponential time to find the matching rule; to prevent this, most PEG
parsers (including the new Python parser) implement the “packrat” method to
cache intermediate results. A packrat parser can process any input in linear
time, but spends some memory on its cache.</p>
<p>PEGEN’s grammar is far more legible than the old one’s, and the grammar
exactly matches all legal Python programs.</p>
<p>CPython’s old parser progresses in stages: the tokenizer feeds the LL(1)
parser, which produces a concrete syntax tree (CST), which is transformed into
the AST. The CST stage is necessary because the parser does not support left
recursion. Consider this expression:</p>
<blockquote>
<div><p>a + b + c</p>
</div></blockquote>
<p>The old parser’s CST is too flat, as the presenters showed in this slide:</p>
<p><a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiXcfvOgplwriw0CYQM1Tpx8ycZGJa-1cdy_M3f4td-9f_rLIamuWP7NEeQHhzxTHekgXLbRtKT1O0BR6W83zcFLgrUKF-C-ue4ZoNlCcRqS_nw2jEmu92MWNlv6Z3j3bsyXg/s1600/parse-tree.png">![</a>](<a class="reference external" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiXcfvOgplwriw0CYQM1Tpx8ycZGJa-1cdy_M3f4td-9f_rLIamuWP7NEeQHhzxTHekgXLbRtKT1O0BR6W83zcFLgrUKF">https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiXcfvOgplwriw0CYQM1Tpx8ycZGJa-1cdy_M3f4td-9f_rLIamuWP7NEeQHhzxTHekgXLbRtKT1O0BR6W83zcFLgrUKF</a>-
C-ue4ZoNlCcRqS_nw2jEmu92MWNlv6Z3j3bsyXg/s1600/parse-tree.png)</p>
<p>In real life, the expression will be evaluated at runtime by first adding _a_
to _b_ , then adding _c_. Unfortunately the CST does not encode this nested
evaluation, so the LL(1) parser must transform the program a second time to
turn the CST into an AST in the properly nested form, which can then generate
bytecode. PEGEN, on the other hand, directly generates the AST. Depending on
the program, PEGEN may use more or less memory: what it spends on the packrat
method, it may save by skipping the CST.</p>
<p>Emily Morehouse tested PEGEN against the old parser by verifying they produce
the same AST for every module in the standard library and the top 3800 PyPI
packages. (PEGEN parses the standard library slightly faster than the old
parser, but uses 10% more memory.)</p>
<p>Once Python has a non-LL(1) parser, its syntax may grow more grammatically
complex; Victor Stinner asked if third-party Python parsers (such as linters
and IDEs) might have difficulty. Van Rossum felt certain they could adopt more
powerful parsers themselves, if necessary.</p>
<p>The authors plan to switch CPython to the new parser cautiously. In Python 3.9
alpha 6 the new parser will be opt-in; it will become the default in beta 1
and in the official 3.9 release, with the old parser still available by a
command line switch. As soon as the new parser is enabled, parenthesized with-
statements will be allowed! In Python 3.10 the old parser will be deleted. PEP
617 must still be approved, however, and the new code needs a final review.</p>
<p>The proposal met no opposition; in fact, several in the audience asked whether
it could become the default sooner.</p>
</section>

<div class="section ablog__blog_comments">
  
  


<div class="section ablog__prev-next">
  <span class="ablog__prev">
    
    
    Previous:
    
    <a href="2020-04-lightning-talks-part-1.html">
      
      <span>Lightning Talks Part 1 - Python Language Summit 2020</span>
    </a>
    
  </span>
  <span class="ablog__spacer">&nbsp;</span>
  <span class="ablog__next">
    
    
    Next:
    
    <a href="2020-04-the-2020-python-language-summit.html">
      <span>The 2020 Python Language Summit</span>
      
    </a>
    
  </span>
</div>

  
  
</div>

      </article>
      
    </main>
  </div><footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2024, Python Software Foundation</p>
  
  <p>
    Made with
    
    <a href="https://www.sphinx-doc.org/">Sphinx</a> and
    
    <a href="https://shibuya.lepture.com">Shibuya theme</a>.
  </p>
</div>
      <div class="sy-foot-socials"></div>
    </div>
  </div>
</footer>
      <script src="../../_static/documentation_options.js?v=8a448e45"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../_static/shibuya.js?v=3cc430e2"></script></body>
</html>